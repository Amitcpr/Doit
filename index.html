<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Task Prioritization App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 2rem auto;
        padding: 1rem;
      }
      label {
        display: block;
        font-weight: bold;
        margin-top: 10px;
      }
      input,
      textarea,
      button {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      button {
        cursor: pointer;
      }
      .task {
        padding: 10px;
        margin: 10px 0;
        border-left: 6px solid #007bff;
        background: #f9f9f9;
        border-radius: 5px;
      }
      .urgent {
        background: #ffe5e5;
        border-left-color: red;
      }
      .overdue {
        background: #ffcccc;
        border-left-color: darkred;
      }
      .completed {
        text-decoration: line-through;
        color: #888;
        background-color: #e6e6e6 !important;
      }
      .task-actions button {
        width: auto;
        margin-right: 10px;
        padding: 5px 10px;
        color: white;
        border: none;
        border-radius: 5px;
      }
      .edit-btn {
        background-color: orange;
      }
      .delete-btn {
        background-color: red;
      }
      .complete-btn {
        background-color: green;
      }
      .hamburger-button {
        background-color: #333;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        margin: 20px 0;
      }
      #menu {
        display: none;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 10px;
        background: #f0f0f0;
        margin-bottom: 20px;
      }
      .select-bar {
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .task-checkbox {
        width: auto;
        margin-right: 10px;
        accent-color: #007bff;
      }
    </style>
  </head>
  <body>
    <h2>Task Prioritization App</h2>

    <label>Merchant Name</label>
    <input type="text" id="merchant" />

    <label>Task Description</label>
    <textarea id="description" maxlength="120"></textarea>

    <label>MRR (in dollars)</label>
    <input type="number" id="mrr" />

    <label>Urgency (1-10)</label>
    <input type="number" id="urgency" />

    <label>Time Needed (in minutes)</label>
    <input type="number" id="time" />

    <label>Escalation Chance (1-10)</label>
    <input type="number" id="escalation" />

    <label>Dependencies (0-5)</label>
    <input type="number" id="dependencies" />

    <label>Deadline</label>
    <input type="datetime-local" id="deadline" />

    <button onclick="addTask()">Add Task</button>

    <div class="select-bar">
      <input type="checkbox" id="selectAll" class="task-checkbox" />
      <label for="selectAll" style="margin: 0;">Select All</label>
      <button onclick="deleteSelectedTasks()" style="width:auto;background:red;color:white;">Delete Selected</button>
    </div>

    <button onclick="toggleMenu()" class="hamburger-button">☰ Menu</button>
    <div id="menu">
      <button onclick="exportExcel()">Export to Excel</button>
      <button onclick="window.print()">Export to PDF</button>
      <button onclick="downloadSample()">Download Sample CSV</button>
      <input type="file" id="csvUpload" accept=".csv,.xlsx" />
    </div>

    <div id="taskList"></div>

    <script>
      let tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
      let editIndex = null;
      let selectedTasks = new Set();

      const weights = {
        mrr: 25,
        urgency: 25,
        time: 10,
        escalation: 30,
        dependencies: 10,
      };

      const normalize = (val, max) => Math.min(val / max, 1);
      const calculatePriority = (t) => {
        const norm = {
          mrr: normalize(t.mrr, 10000),
          urgency: normalize(t.urgency, 10),
          time: 1 - normalize(t.time, 120),
          escalation: normalize(t.escalation, 10),
          dependencies: normalize(t.dependencies, 5),
        };
        return (
          ((norm.mrr * weights.mrr +
            norm.urgency * weights.urgency +
            norm.time * weights.time +
            norm.escalation * weights.escalation +
            norm.dependencies * weights.dependencies) /
            100) *
          100
        );
      };

      const saveTasks = () =>
        localStorage.setItem("tasks", JSON.stringify(tasks));

      const renderTasks = () => {
        const container = document.getElementById("taskList");
        container.innerHTML = "";

        // Incomplete tasks sorted by priority
        const incomplete = tasks
          .map((t, i) => ({ ...t, idx: i }))
          .filter(t => !t.completed)
          .sort((a, b) => b.priority - a.priority);

        // Completed tasks sorted by completedAt (oldest first)
        const completed = tasks
          .map((t, i) => ({ ...t, idx: i }))
          .filter(t => t.completed)
          .sort((a, b) => new Date(a.completedAt || 0) - new Date(b.completedAt || 0));

        const allTasks = [...incomplete, ...completed];

        allTasks.forEach((t, i) => {
          const taskDiv = document.createElement("div");
          taskDiv.className = "task";
          const now = new Date();
          const deadline = new Date(t.deadline);
          if (deadline - now <= 86400000 && deadline > now)
            taskDiv.classList.add("urgent");
          if (deadline < now) taskDiv.classList.add("overdue");
          if (t.completed) taskDiv.classList.add("completed");

          const checked = selectedTasks.has(t.idx) ? 'checked' : '';

          taskDiv.innerHTML = `
            <input type="checkbox" class="task-checkbox" data-idx="${t.idx}" ${checked} />
            <strong>${t.merchant}</strong> – ${t.description}<br/>
            Deadline: ${deadline.toLocaleString()}<br/>
            Priority: ${t.priority.toFixed(2)}<br/>
            MRR: $${t.mrr}, Urgency: ${t.urgency}, Time: ${t.time} mins,<br/>
            Escalation: ${t.escalation}, Dependencies: ${t.dependencies}
            ${t.completed && t.completedAt ? `<br/>Completed At: ${new Date(t.completedAt).toLocaleString()}` : ''}
            <div class="task-actions">
              <button class="edit-btn" onclick="editTask(${t.idx})">Edit</button>
              <button class="delete-btn" onclick="deleteTask(${t.idx})">Delete</button>
              <button class="complete-btn" onclick="toggleComplete(${t.idx})">
                ${t.completed ? "Undo" : "Complete"}
              </button>
            </div>
          `;
          container.appendChild(taskDiv);
        });

        // Re-attach event listeners for checkboxes
        document.querySelectorAll('.task-checkbox[data-idx]').forEach(cb => {
          cb.addEventListener('change', function() {
            const idx = parseInt(this.getAttribute('data-idx'));
            if(this.checked) {
              selectedTasks.add(idx);
            } else {
              selectedTasks.delete(idx);
            }
            updateSelectAllCheckbox();
          });
        });

        updateSelectAllCheckbox();
      };

      document.getElementById('selectAll').addEventListener('change', function() {
        if(this.checked) {
          selectedTasks = new Set(tasks.map((_, i) => i));
        } else {
          selectedTasks.clear();
        }
        renderTasks();
      });

      function updateSelectAllCheckbox() {
        const selectAll = document.getElementById('selectAll');
        if(selectedTasks.size === 0) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
        } else if(selectedTasks.size === tasks.length) {
          selectAll.checked = true;
          selectAll.indeterminate = false;
        } else {
          selectAll.checked = false;
          selectAll.indeterminate = true;
        }
      }

      function deleteSelectedTasks() {
        if(selectedTasks.size === 0) {
          alert("No tasks selected!");
          return;
        }
        if(confirm(`Delete ${selectedTasks.size} selected task(s)?`)) {
          tasks = tasks.filter((_, i) => !selectedTasks.has(i));
          selectedTasks.clear();
          saveTasks();
          renderTasks();
        }
      }

      const addTask = () => {
        const task = {
          merchant: document.getElementById("merchant").value.trim(),
          description: document.getElementById("description").value.trim(),
          mrr: parseFloat(document.getElementById("mrr").value),
          urgency: parseFloat(document.getElementById("urgency").value),
          time: parseFloat(document.getElementById("time").value),
          escalation: parseFloat(document.getElementById("escalation").value),
          dependencies: parseFloat(
            document.getElementById("dependencies").value
          ),
          deadline: document.getElementById("deadline").value,
          completed: false,
        };
        task.priority = calculatePriority(task);
        if (editIndex !== null) {
          // preserve completed/completedAt if editing an existing task
          task.completedAt = tasks[editIndex].completedAt || null;
          task.completed = tasks[editIndex].completed || false;
          tasks[editIndex] = task;
          editIndex = null;
        } else {
          tasks.push(task);
        }
        saveTasks();
        renderTasks();
        document
          .querySelectorAll("input, textarea")
          .forEach((e) => (e.value = ""));
      };

      const editTask = (i) => {
        const t = tasks[i];
        document.getElementById("merchant").value = t.merchant;
        document.getElementById("description").value = t.description;
        document.getElementById("mrr").value = t.mrr;
        document.getElementById("urgency").value = t.urgency;
        document.getElementById("time").value = t.time;
        document.getElementById("escalation").value = t.escalation;
        document.getElementById("dependencies").value = t.dependencies;
        document.getElementById("deadline").value = t.deadline;
        editIndex = i;
      };

      const deleteTask = (i) => {
        if (confirm("Delete this task?")) {
          tasks.splice(i, 1);
          selectedTasks.delete(i);
          saveTasks();
          renderTasks();
        }
      };

      const toggleComplete = (i) => {
        if (!tasks[i].completed) {
          tasks[i].completed = true;
          tasks[i].completedAt = new Date().toISOString();
        } else {
          tasks[i].completed = false;
          delete tasks[i].completedAt;
        }
        saveTasks();
        renderTasks();
      };

      const toggleMenu = () => {
        const menu = document.getElementById("menu");
        menu.style.display = menu.style.display === "none" ? "block" : "none";
      };

      const exportExcel = () => {
        const ws = XLSX.utils.json_to_sheet(tasks);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Tasks");
        XLSX.writeFile(wb, "tasks.xlsx");
      };

      const downloadSample = () => {
        const sample = [
          {
            merchant: "Demo Corp",
            description: "Urgent ticket follow-up",
            mrr: 4000,
            urgency: 9,
            time: 30,
            escalation: 8,
            dependencies: 2,
            deadline: new Date().toISOString(),
          },
        ];
        const ws = XLSX.utils.json_to_sheet(sample);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sample");
        XLSX.writeFile(wb, "sample_task_upload.xlsx");
      };

      document
        .getElementById("csvUpload")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = function (evt) {
            const data = evt.target.result;
            const workbook = XLSX.read(data, { type: "binary" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet);
            json.forEach((task) => {
              task.priority = calculatePriority(task);
              task.completed = false;
            });
            tasks = tasks.concat(json);
            saveTasks();
            renderTasks();
          };
          reader.readAsBinaryString(file);
        });

      renderTasks();
    </script>
  </body>
</html>
